# CHANGELOG - WAV音声再生機能の実装とWSL2音声設定

**作成日時**: 2025-10-17 02:15
**作業内容**: WAVファイル再生機能の実装、テスト作成、WSL2環境での音声出力設定

---

## 実装内容

### 1. WAV音声再生モジュールの実装

デバイス選択可能なWAVファイル再生機能を実装しました。

**実装ファイル**: [src/audio_player.py](../src/audio_player.py)

**主な機能**:
- 利用可能な音声出力デバイスの一覧表示
- ユーザーによるデバイス選択（対話的）
- WAVファイルの再生（デバイス指定可/デフォルト）
- CLIエントリーポイント

**主要クラス**:
- `AudioPlayer`: WAVファイル再生を管理するクラス
  - `get_output_devices()`: 出力デバイス一覧取得
  - `print_output_devices()`: デバイス一覧表示
  - `play_wav()`: WAVファイル再生
  - `select_and_play()`: 対話的にデバイス選択して再生

### 2. テストコードの実装

**テストファイル**: [tests/test_audio_player.py](../tests/test_audio_player.py)

**テスト項目**:
- AudioPlayerの初期化テスト
- 出力デバイス一覧取得のテスト
- デバイス一覧表示のテスト
- WAVファイル再生のテスト（正常系）
- デバイス指定での再生テスト
- ファイルが存在しない場合のエラーハンドリングテスト
- デフォルトデバイスでの再生テスト

**テスト結果**: 全7件パス ✓

### 3. サンプルWAVファイルの生成

**生成スクリプト**: [samples/generate_test_wav.py](../samples/generate_test_wav.py)

**生成ファイル**:
- `samples/test_440hz.wav`: 2秒間の440Hz正弦波（ラ音）
- `samples/test_880hz.wav`: 1秒間の880Hz正弦波

### 4. テスト実行スクリプトの作成

**ファイル**: [test_play.py](../test_play.py)

音声デバイスの確認と、サンプルWAVファイルの自動再生を行うテストスクリプトです。

### 5. WSL2音声出力設定ドキュメントの作成

**ドキュメント**: [doc/WSL2_AUDIO_SETUP.md](../doc/WSL2_AUDIO_SETUP.md)

WSL2環境でPyAudioを使用して音声出力を行うための詳細な設定手順をまとめました。

**内容**:
- WSLgの確認方法
- PulseAudioクライアントツールのインストール手順
- ALSA設定ファイル（~/.asoundrc）の作成方法
- トラブルシューティング
- 2025年時点での最新推奨方法

---

## 変更ファイル一覧

### 新規作成
- `src/audio_player.py` - WAV再生モジュール
- `tests/test_audio_player.py` - テストコード
- `samples/generate_test_wav.py` - サンプルWAV生成スクリプト
- `samples/test_440hz.wav` - テスト用音声ファイル（440Hz）
- `samples/test_880hz.wav` - テスト用音声ファイル（880Hz）
- `test_play.py` - 音声再生テストスクリプト
- `doc/WSL2_AUDIO_SETUP.md` - WSL2音声設定ドキュメント
- `doc/CHANGELOG_20251017_0215.md` - このファイル

### 変更
- `pyproject.toml` - pyaudio依存関係を追加

---

## 技術詳細

### 使用ライブラリ
- **pyaudio (>=0.2.14)**: Python音声入出力ライブラリ
- **wave**: WAVファイル読み込み（標準ライブラリ）

### システム要件
- **WSL2環境**: Windows 11 または Windows 10（ビルド21364以降）
- **WSLg**: GUI/音声サポート（Windows 11では標準搭載）
- **PulseAudio**: 音声サーバー（WSLg経由）

### WSL2での音声出力設定

WSL2で音声を出力するために、以下の設定を実施：

1. **PulseAudioクライアントツールのインストール**:
   ```bash
   sudo apt install -y pulseaudio-utils libasound2-plugins
   ```

2. **ALSA設定（~/.asoundrc）**:
   ALSAがPulseAudioを使用するように設定ファイルを作成

3. **WSLgのPulseAudioサーバー接続**:
   - 環境変数 `PULSE_SERVER=unix:/mnt/wslg/PulseServer`（自動設定済み）
   - RDPSinkデバイス経由でWindows音声システムに出力

---

## 使用方法

### 基本的な使い方

```bash
# デバイス選択して再生（対話的）
uv run python src/audio_player.py samples/test_440hz.wav

# テストスクリプトで自動再生
uv run python test_play.py

# テスト実行
uv run pytest tests/test_audio_player.py -v
```

### Pythonコードから使用

```python
from src.audio_player import AudioPlayer

player = AudioPlayer()

# デバイス一覧を表示
player.print_output_devices()

# デフォルトデバイスで再生
player.play_wav("samples/test_440hz.wav")

# デバイスを指定して再生
player.play_wav("samples/test_440hz.wav", device_index=0)
```

---

## 動作確認結果

### テスト実行結果
```
tests/test_audio_player.py::TestAudioPlayer::test_init PASSED
tests/test_audio_player.py::TestAudioPlayer::test_get_output_devices PASSED
tests/test_audio_player.py::TestAudioPlayer::test_print_output_devices PASSED
tests/test_audio_player.py::TestAudioPlayer::test_play_wav_with_valid_file PASSED
tests/test_audio_player.py::TestAudioPlayer::test_play_wav_with_device_index PASSED
tests/test_audio_player.py::TestAudioPlayer::test_play_wav_file_not_found PASSED
tests/test_audio_player.py::TestAudioPlayer::test_select_and_play_with_default_device PASSED

7 passed in 0.35s
```

### 音声再生テスト結果
```
=== 音声出力デバイス一覧 ===
[0] pulse
    最大出力チャンネル数: 32
    デフォルトサンプリングレート: 44100.0Hz
[1] default
    最大出力チャンネル数: 32
    デフォルトサンプリングレート: 44100.0Hz

【テスト1】デフォルトデバイスで440Hz音声を再生
✓ 再生完了

【テスト2】デフォルトデバイスで880Hz音声を再生
✓ 再生完了
```

---

## 今後の拡張案

- MP3/OGG等の他の音声フォーマット対応
- 音量調整機能
- 再生中の一時停止/再開機能
- 再生位置のシーク機能
- プレイリスト機能

---

## 参考資料

- [WSLg公式リポジトリ](https://github.com/microsoft/wslg)
- [WSL音声サポートIssue](https://github.com/microsoft/WSL/issues/5816)
- [PyAudio公式ドキュメント](https://people.csail.mit.edu/hubert/pyaudio/)

---

**作業完了**: 2025-10-17 02:15
