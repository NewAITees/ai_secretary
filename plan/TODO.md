# TODOリスト（優先順位付き）

## 設計方針：外部システムアクセス

**LLM秘書が外部システムやサービスにアクセスする際の統一要件:**
- すべての外部システム連携は **BASHコマンドを通じて実行** する
- 各機能は単独で実行可能なBASHスクリプトまたはコマンドとして提供する
- AI秘書は `subprocess` 経由でこれらのコマンドを呼び出し、標準出力/標準エラー出力を解析する
- 認証情報やAPIキーは環境変数または設定ファイルで管理し、コマンドライン引数での受け渡しを避ける

この方針により、AI秘書は統一されたインターフェース（BASH実行）で多様なツールを利用できるようになる。

---

## 優先度サマリー（簡単に進められるものを上位に配置）

| Priority | ID | タスク | 根拠/メモ |
| --- | --- | --- | --- |
| P1 | #2 | TODOリスト操作 | 既存DBとAPIに小規模テーブル追加で着手可能 |
| P2 | #3 | 「今日やったこと」記録 | lifelog-systemのログ設計を流用できる |
| P3 | #7 | チャット履歴保存 | `src/ai_secretary/secretary.py`はメモリ保持のみで拡張余地大 |
| P4 | #8 | 定期削除処理 | jobスケジューラ追加とポリシー定義で完結 |
| P5 | #6 | 日次サマリー生成 | lifelog-systemの`cli_viewer`が参考になる |
| P6 | #1 | ウェブ履歴のDB格納 | lifelog-systemに将来拡張案ありだが未実装 |
| P7 | #10 | ネット検索連携 | 外部I/Oが必要でサンドボックス配慮が必要 |
| P8 | #4 | AI秘書の機能アクセス設計 | 権限情報整理とAPI化で規模中 |
| P9 | #5 | 履歴を元にした提案 | 推論ロジックと評価ループ構築が必要 |
| P10 | #9 | 能動会話の高度化 | 対話制御の刷新で最も複雑 |

以下、各タスクの詳細と調査メモ。

---

### [#2 / P1] TODOリストを操作できるようにする
- 既存データストア内にTODOエンティティを追加し、作成/更新/削除/完了フローを設計する。
- CLIまたはUIから操作できるAPIを公開し、AI秘書からも利用できるインターフェースを整える。
- **外部システムアクセス方針**: AI秘書はBASHコマンド（例: `uv run python -m src.todo.cli add "タスク名"`）経由でTODO操作を実行する。
- **調査メモ**: 現状`rg`検索でTODO管理コードは見当たらないため、新規テーブルとAPIエンドポイントの追加が必要（2025-??-??時点）。
- **進捗 (2025-11-11)**: `src/todo/`以下にSQLiteリポジトリを追加し、`/api/todos` CRUDエンドポイント + フロントUIを実装。`AISecretary`はTODOコンテキストを会話へ注入し、`todoActions`でAI側から登録/更新/完了が可能。`tests/test_todo_repository.py`・`tests/test_todo_api.py`・`tests/test_todo_llm_integration.py`でストレージ/REST/LLM連携の動作をカバー。

### [#3 / P2] 「今日やったこと」を記録する
- 日次ログ入力用のエンドポイントと保存スキーマを定義し、手動入力と自動収集双方に対応する。
- 過去ログの検索やタグ付けを可能にして、振り返りの基盤を作る。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由でログ記録スクリプトを実行する（例: `./scripts/log_activity.sh "作業内容"`）。
- **調査メモ**: `lifelog-system/README.md`と`lifelog-system/src/cli_viewer.py`に日次サマリー/タイムライン参照機能があり、スキーマやAPI再利用が可能。

### [#7 / P3] チャット履歴を保存する
- AI秘書との会話ログ保存ポリシーを定め、暗号化・検索性を両立するストレージを選定する。
- 必要なメタデータ（会話ID、ユーザー操作、AIアクション）を含んだスキーマを設計する。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由で履歴保存・検索を実行する（例: `./scripts/save_chat.sh` または `./scripts/search_chat.sh "キーワード"`）。
- **調査メモ**: `src/ai_secretary/secretary.py`では`self.conversation_history`がメモリ保持のまま消える。DB/ファイル永続化の追加が未着手。

### [#8 / P4] 履歴や音声などのファイルを定期削除する
- データ保持期間ポリシーを設定し、自動削除ジョブをスケジューリングする。
- 削除前アーカイブ、監査ログ、ユーザー確認フローが必要か検討する。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由で削除スクリプトを実行する（例: `./scripts/cleanup_old_files.sh --days 30`）。cronジョブとして登録する場合もBASHスクリプトを用いる。
- **調査メモ**: `lifelog-system`にデーモンとスケジューラが既に存在するため、同等のジョブ登録方式を流用できる可能性あり。

### [#6 / P5] 一日のサマリーを生成する機能を作る
- 日次ログと自動取得データを集約し、自然言語サマリーやKPIを出力するパイプラインを構築する。
- サマリーの配信チャネル（メール/チャット/UI）と保存先を決める。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由でサマリー生成を実行する（例: `./scripts/generate_daily_summary.sh --date 2025-11-11`）。出力は標準出力またはファイルで受け取る。
- **調査メモ**: `lifelog-system/src/cli_viewer.py`には`show_daily_summary`がありSQLビューも揃っているため、結果をAI秘書が取得するAPI化が容易。

### [#1 / P6] ウェブサイトの閲覧履歴をDBに格納する
- 収集対象となるブラウザや取得方法を確定し、必要なスクレイピング/ログ連携コードを実装する。
- lifelog用DBに履歴テーブルを追加し、時刻・URL・タイトル・メタ情報を保存するデータモデルを決める。
- 定期的な取り込みジョブと重複排除ロジックを整備し、履歴参照APIを用意する。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由でブラウザ履歴取得を実行する（例: `./scripts/import_browser_history.sh --browser chrome`）。
- **調査メモ**: `lifelog-system/README.md`の「今後の拡張」にブラウザ履歴統合が記載されているがコードは未実装。新規Collectorが必要。

### [#10 / P7] ネット検索で最新情報を取得する
- サンドボックス化された検索コネクタを実装し、結果を要約してAI秘書へ渡す。
- キャッシュ、レート制限、利用規約順守の仕組みを整える。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由で検索を実行する（例: `./scripts/web_search.sh "検索クエリ"`）。結果はJSON形式で標準出力に返す。
- **調査メモ**: 既存コードにHTTP検索コネクタは確認できず、新規で安全な外部アクセスレイヤーを設計する必要がある。

### [#4 / P8] AI秘書が各種機能にアクセスする方法を設計する
- AIエージェントが呼び出せる権限管理付きAPIレイヤーを整理し、利用ケースごとのプロンプト/ツール設計を行う。
- 外部サービス連携や安全装置（レート制限、監査ログなど）を検討する。
- **外部システムアクセス方針**: すべての外部機能はBASHコマンド経由で実行可能にする。AI秘書は`subprocess`モジュールでコマンドを呼び出し、結果を解析する統一インターフェースを持つ。
- **調査メモ**: FastAPI層（`src/server/app.py`）はシンプルな`/api/chat`のみ。将来のツール呼び出しAPIを追加する設計作業が必要。

### [#5 / P9] AI秘書が履歴を受け取り提案できるようにする
- 収集済みの各種履歴（ウェブ/TODO/日次ログなど）を要約するストリームを準備し、AI秘書へ供給する。
- 提案生成アルゴリズムと評価フロー（重複提案防止、ユーザーフィードバック学習）を設計する。
- **外部システムアクセス方針**: AI秘書はBASHコマンド経由で履歴取得を実行する（例: `./scripts/get_recent_history.sh --type web --limit 100`）。結果はJSON形式で受け取る。
- **調査メモ**: 提案ロジックや学習フローは未定義。履歴統合とプロンプトテンプレートの設計が大きな作業となる。

### [#9 / P10] 能動的な会話を複雑化し面白くする
- 対話状態管理の改善、話題転換ロジック、多段プランニングなどを導入して文脈保持力を強化する。
- エンタメ要素（小ネタ、雑談、提案テンプレート）を追加し、ユーザー設定で調整できるようにする。
- **外部システムアクセス方針**: 会話の素材取得（天気情報、ニュースなど）はBASHコマンド経由で実行する（例: `./scripts/get_weather.sh`、`./scripts/get_news_headlines.sh`）。
- **調査メモ**: `src/ai_secretary/scheduler.py`と`prompt_templates.py`が既存の能動会話機能。ここを大幅改修する必要があるため最下位優先。
